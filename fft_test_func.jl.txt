using PyPlot

default_figsize = (6.4, 4.8)  # ‚±‚ÌƒfƒtƒHƒ‹ƒgƒTƒCƒY‚Í‘å‚«‰ß‚¬‚é‚Ì‚Å
rc("figure", figsize=(3,2.4)) # ‚±‚Ì‚æ‚¤‚É¬‚³‚­‚µ‚Ä‚¨‚­.

# right-open interval [a,b)
#
roi(a, b, N) = collect(linspace(a, b-(b-a)/N, N))

# x axis (Assume the priodic boundary condition with period L)
#
x_axis(L, N) = roi(-L/2, L/2, N)

# k axis (k = the wave number)
#
function k_axis(N)
    @assert iseven(N)
    Ndiv2 = div(N,2)
    vcat(roi(0,Ndiv2,Ndiv2), roi(-Ndiv2,0,Ndiv2))
end

# FFT Data
#
mutable struct FFT_Data{T<:Real, S}
    K::T
    L::T
    N::Int64
    x::Array{T,1}
    k::Array{T,1}
    D::Array{Complex{T},1}
    D2::Array{Complex{T},1}
    D3::Array{Complex{T},1}
    D4::Array{Complex{T},1}
    FFT::S
end

# FFT € (D.^m .* (FFT * y)) = (d/dx)^m y
#
function FFT_Data(K, N)
    L = 2ƒÎ*K
    x = x_axis(L, N)
    k = k_axis(N)
    D = im .* k ./ K
    FFT  = plan_fft(Array{Complex{Float64},1}(N))
    FFT_Data(Float64(K), L, N, x, k, D, D.^2, D.^3, D.^4, FFT)
end

# exp(ƒ¢t (d/dx)^2) y
#
update_heat(o::FFT_Data, y, ƒ¢t) = o.FFT € (exp.(ƒ¢t .* o.D2) .* (o.FFT * y))

# nearly zero
#
function imagisnealyzero(z)
    maximum(abs, imag(z))/(maximum(abs, real(z)) + 1e-15) < 1e-3
end

# plot y
#
function plot_y(o::FFT_Data, y)
    plot(o.x, real(y), label="Re", lw=0.8)
    imagisnealyzero(y) || plot(o.x, imag(y), label="Im", lw=0.8, ls="--")
    grid(ls=":")
    xlabel("x")
    # legend()
end

# plot yhat
#
function plot_yhat(o::FFT_Data, yhat)
    plot(o.k, real(yhat), label="Re", lw=0.8)
    imagisnealyzero(yhat) || plot(o.k, imag(yhat), label="Im", lw=0.8, ls="--")
    grid(ls=":")
    xlabel("k")
    # legend()
end
